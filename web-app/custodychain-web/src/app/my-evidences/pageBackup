"use client";

import Input from "@/src/components/ui/Input";
import Button from "@/src/components/ui/Button";
import { useState } from "react";
import { useWeb3 } from "@/src/context-and-hooks/Web3Context";
import { useEvidences } from "@/src/context-and-hooks/EvidencesContext";
import { SocketEvidenceDetails } from "@/src/lib/types/socketEvent.types";
import {
  bigintToDateWithTimeStamp,
  bigIntToIsoDate,
} from "@/src/lib/util/helpers";
import Link from "next/link";

type dateValueType = "CREATED" | "UPDATED";

interface DateFilter {
  created: string[];
  updated: string[];
}

export default function MyEvidencePage() {
  //Filters
  const [statusFilter, setStatusFilter] = useState<
    "All" | "Active" | "Discontinued"
  >("Active");
  const [roleFilter, setRoleFilter] = useState<"All" | "Owned" | "Created">(
    "All",
  );

  const [datesFilter, setDatesFilter] = useState<DateFilter>({
    created: [],
    updated: [],
  });
  //Sort values
  const [sortBy, setSortBy] = useState<dateValueType>("UPDATED");
  const [sortOrder, setSortOrder] = useState<"asc" | "desc">("desc");

  const { account } = useWeb3();
  const { evidences, isLoadingEvidences } = useEvidences();

  const isStatusAndAccountfilterMatch = (e: SocketEvidenceDetails) =>
    (statusFilter === "All"
      ? e.status === "active" || e.status === "discontinued"
      : e.status === statusFilter.toLowerCase()) &&
    (roleFilter === "Created"
      ? e.creator === account
      : roleFilter === "Owned"
        ? e.currentOwner === account
        : e.creator === account || e.currentOwner === account);

  const isDatesFilterMatch = (e: SocketEvidenceDetails) => {
    const isoCreated = bigIntToIsoDate(BigInt(e.createdAt));
    const isoUpdated = bigIntToIsoDate(BigInt(e.updatedAt));
    const matchesCreated =
      datesFilter.created.length > 0 &&
      datesFilter.created.includes(isoCreated);
    const matchesUpdated =
      datesFilter.updated.length > 0 &&
      datesFilter.updated.includes(isoUpdated);
    return matchesCreated || matchesUpdated;
  };
  const hasDates =
    datesFilter.created.length > 0 || datesFilter.updated.length > 0;
  // keeps original evidences list untouched
  const sortedEvidences = evidences.slice().sort((a, b) => {
    const valA =
      sortBy === "CREATED" ? BigInt(a.createdAt) : BigInt(a.updatedAt);
    const valB =
      sortBy === "CREATED" ? BigInt(b.createdAt) : BigInt(b.updatedAt);
    if (valA === valB) return 0;
    if (sortOrder === "asc") {
      return valA < valB ? -1 : 1;
    } else {
      return valA > valB ? -1 : 1;
    }
  });

  const filteredEvidences = hasDates
    ? sortedEvidences.filter(
        (e) => isStatusAndAccountfilterMatch(e) && isDatesFilterMatch(e),
      )
    : sortedEvidences.filter((e) => isStatusAndAccountfilterMatch(e));

  const dateTypeEl = document.getElementById(
    "dateType-button-text",
  ) as HTMLElement;

  function handleSubmit(event: React.FormEvent<HTMLFormElement>) {
    event.preventDefault();
    const formData = new FormData(event.currentTarget);

    const dateValue = formData.get("dateValue") as string;
    const dateTypeElText = dateTypeEl.innerText.toLowerCase();

    const dateType = (
      dateTypeElText.includes("created") ? "created" : "updated"
    ) as keyof DateFilter;

    if (datesFilter[dateType].includes(dateValue)) {
      const dropDownEl = document.getElementById(`${dateType}At-dropdown`);
      (dropDownEl as HTMLElement).style.opacity = "1";
      return;
    }
    setDatesFilter((prev) => ({
      ...prev,
      [dateType]: [...prev[dateType], dateValue],
    }));
  }
  // to avoid re render on state changes
  function handleDateTypeChanged() {
    if (dateTypeEl.innerText === "UPDATED ON") {
      dateTypeEl.innerText = "CREATED ON";
    } else {
      dateTypeEl.innerText = "UPDATED ON";
    }
  }

  return (
    <div className="flex-none">
      <div className="grid grid-cols-[1.5fr_0.75fr_1.5fr] gap-x-3">
        {/* 1. search and filters col */}
        <div>
          {/* search bar */}
          <label
            htmlFor="filter-select"
            className="block font-mono font-medium text-lg text-orange-900"
          >
            Search Evidence:
          </label>
          <Input
            className="h-[52px]"
            placeholder="Search by ID, Creator, Current Owner etc"
          />
          {/* filter by status and account */}
          <label
            htmlFor="filter-select"
            className="block font-mono font-medium text-lg text-orange-900"
          >
            Filter By Status And Account:
          </label>
          <div id="filter-select" className="grid grid-rows-[1fr_1fr] gap-y-1">
            <nav
              className="grid grid-cols-[1fr_1fr_1fr] border-2 border-orange-700 *:border-orange-700 bg-orange-50 font-mono font-[500] text-orange-900"
              aria-label="Tabs"
            >
              <button
                onClick={() => {
                  if (statusFilter !== "All") {
                    setStatusFilter("All");
                  }
                }}
                type="button"
                className={`py-2 px-3 ${
                  statusFilter === "All"
                    ? "bg-orange-500 font-[600] text-white"
                    : "hover:font-[600] hover:bg-orange-200"
                }`}
              >
                ALL
              </button>
              <button
                onClick={() => {
                  if (statusFilter !== "Active") {
                    setStatusFilter("Active");
                  }
                }}
                type="button"
                className={`py-2 px-3 border-x-2 ${
                  statusFilter === "Active"
                    ? "bg-orange-500 font-[600] text-white"
                    : "hover:font-[600] hover:bg-orange-200"
                }`}
              >
                ACTIVE
              </button>
              <button
                onClick={() => {
                  if (statusFilter !== "Discontinued") {
                    setStatusFilter("Discontinued");
                  }
                }}
                type="button"
                className={`py-2 px-3 ${
                  statusFilter === "Discontinued"
                    ? "bg-orange-500 font-[600] text-white"
                    : "hover:font-[600] hover:bg-orange-200"
                }`}
              >
                DISCONTINUED
              </button>
            </nav>
            <nav
              className="grid grid-cols-[1fr_1fr_1fr] rounded-b-sm border-2 border-orange-700 *:border-orange-700 bg-orange-50 font-mono font-[500] text-orange-900"
              aria-label="Tabs"
            >
              <button
                onClick={() => {
                  if (roleFilter !== "All") {
                    setRoleFilter("All");
                  }
                }}
                type="button"
                className={`py-2 px-3 ${
                  roleFilter === "All"
                    ? "bg-orange-500 font-[600] text-white"
                    : "hover:rounded-b-sm hover:font-[600] hover:bg-orange-200"
                }`}
              >
                ALL
              </button>
              <button
                onClick={() => {
                  if (roleFilter !== "Created") {
                    setRoleFilter("Created");
                  }
                }}
                type="button"
                className={`py-2 px-3 border-x-2 ${
                  roleFilter === "Created"
                    ? "bg-orange-500 font-[600] text-white"
                    : "hover:font-[600] hover:bg-orange-200"
                }`}
              >
                CREATED
              </button>
              <button
                onClick={() => {
                  if (roleFilter !== "Owned") {
                    setRoleFilter("Owned");
                  }
                }}
                type="button"
                className={`py-2 px-3 ${
                  roleFilter === "Owned"
                    ? "bg-orange-500 font-[600] text-white"
                    : "hover:rounded-b-sm hover:font-[600] hover:bg-orange-200"
                }`}
              >
                OWNED
              </button>
            </nav>
          </div>
        </div>

        {/* 2.SORT SECTION */}

        <div className="h-[200px] flex flex-col justify-between">
          <label className="font-mono font-medium text-lg text-orange-900">
            Sort By Date:
          </label>
          <nav
            className="grid grid-rows-[1fr_1fr] border-2 rounded-t-sm border-orange-700 bg-orange-50 font-mono font-[500] text-orange-900"
            aria-label="Tabs"
          >
            <button
              onClick={() => {
                if (sortBy !== "UPDATED") {
                  setSortBy("UPDATED");
                }
              }}
              type="button"
              className={`py-2 px-3 ${
                sortBy === "UPDATED"
                  ? "bg-orange-500 font-[600] text-white"
                  : "hover:rounded-t-sm hover:font-[600] hover:bg-orange-200"
              }`}
            >
              UPDATED
            </button>
            <button
              onClick={() => {
                if (sortBy !== "CREATED") {
                  setSortBy("CREATED");
                }
              }}
              type="button"
              className={`py-2 px-3 ${
                sortBy === "CREATED"
                  ? "bg-orange-500 font-[600] text-white"
                  : "hover:font-[600] hover:bg-orange-200"
              }`}
            >
              CREATED
            </button>
          </nav>
          <label className="font-mono font-medium text-lg text-orange-900">
            Order By:
          </label>
          <button
            id="sortOrder-select"
            onClick={() => {
              if (sortOrder === "asc") {
                setSortOrder("desc");
              } else {
                setSortOrder("asc");
              }
            }}
            type="button"
            className={`h-[52px] px-2 font-mono font-[600] text-white bg-orange-500 rounded-b-sm border-2 border-orange-700`}
          >
            {sortOrder === "desc" ? (
              <p>
                LATEST FIRST <span className="text-2xl">⭫</span>
              </p>
            ) : (
              <p>
                OLDEST FIRST <span className="text-2xl">⭭</span>
              </p>
            )}
          </button>
        </div>

        {/* 3. Find By date */}

        <div>
          <label className="block font-mono font-medium text-lg text-orange-900">
            Find By Date:
          </label>
          <form
            onSubmit={handleSubmit}
            className="grid grid-cols-[2fr_1.5fr_0.5fr_0.5fr] gap-x-2"
          >
            <Input name="dateValue" className="h-[52px]" type="date" required />
            <button
              onClick={handleDateTypeChanged}
              type="button"
              className=" flex justify-between items-center px-3 font-mono font-[600] text-white bg-orange-500 rounded-sm border-2 border-orange-700"
            >
              <div id="dateType-button-text">UPDATED ON</div>
              <div className="h-[20px] w-[20px] rounded-full bg-orange-50 text-orange-500">
                ⮁
              </div>
            </button>
            <Button type="submit" variant="secondary" className="rounded-full">
              +
            </Button>
            <Button
              onClick={() => {
                setDatesFilter({
                  created: [],
                  updated: [],
                });
              }}
              type="button"
              variant="secondary"
              className="rounded-full"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                height="24px"
                viewBox="0 -960 960 960"
                width="24px"
                fill="#ca3500"
              >
                <path d="M280-120q-33 0-56.5-23.5T200-200v-520q-17 0-28.5-11.5T160-760q0-17 11.5-28.5T200-800h160q0-17 11.5-28.5T400-840h160q17 0 28.5 11.5T600-800h160q17 0 28.5 11.5T800-760q0 17-11.5 28.5T760-720v520q0 33-23.5 56.5T680-120H280Zm148.5-171.5Q440-303 440-320v-280q0-17-11.5-28.5T400-640q-17 0-28.5 11.5T360-600v280q0 17 11.5 28.5T400-280q17 0 28.5-11.5Zm160 0Q600-303 600-320v-280q0-17-11.5-28.5T560-640q-17 0-28.5 11.5T520-600v280q0 17 11.5 28.5T560-280q17 0 28.5-11.5Z" />
              </svg>
            </Button>
          </form>
          <label className="block font-mono font-medium text-lg text-orange-900">
            Find By Date Range:
          </label>
        </div>
      </div>

      {/* Evidences */}
      <div className="relative mt-2 grid gap-y-3 border-x-2 border-t-2 rounded-t-sm border-orange-700">
        <div className="h-[58px] z-99 absolute top-0 right-0 left-0 flex justify-start p-3 backdrop-blur-xs bg-orange-100/75 rounded-t-md border-b-2 border-orange-700">
          <div className="mr-2 font-sans font-[500] text-2xl text-orange-900 ">
            {statusFilter} Evidences{", "}
            {roleFilter === "All" ? "Created or Owned" : roleFilter} by
            You:{" "}
          </div>
          {hasDates && (
            <div className="flex flex-row items-center text-orange-900">
              {datesFilter.created.length > 0 && (
                <div className="relative mr-2">
                  <button
                    onClick={() => {
                      const createdAtDropDownEl = document.getElementById(
                        "createdAt-dropdown",
                      ) as HTMLElement;
                      if (createdAtDropDownEl.style.opacity === "1") {
                        createdAtDropDownEl.style.opacity = "0";
                      } else {
                        createdAtDropDownEl.style.opacity = "1";
                      }
                    }}
                    className="w-[164px] flex justify-between p-2 rounded-full bg-orange-500 text-sm text-white font-sans font-[600] border-2 border-orange-700"
                  >
                    <p>CREATED ON</p>
                    <div className="h-[20px] w-[20px] rounded-full bg-orange-50 text-orange-500">
                      {datesFilter.created.length}
                    </div>
                    <div className="h-[20px] w-[20px] rounded-full bg-orange-50 text-orange-500">
                      ⯆
                    </div>
                  </button>
                  <div
                    id="createdAt-dropdown"
                    className="absolute z-100 opacity-0 rounded-sm bg-orange-100 border-x-2 border-orange-700"
                  >
                    {datesFilter.created.map((d) => (
                      <div
                        key={`created-${d}`}
                        className="p-2 last:rounded-b-sm border-b-2 border-orange-700 font-mono font-semibold text-md text-orange-900"
                      >
                        {new Date(d).toDateString()}
                      </div>
                    ))}
                  </div>
                </div>
              )}
              {datesFilter.updated.length > 0 && (
                <div className="relative mr-2">
                  <button
                    onClick={() => {
                      const updatedAtDropDownEl = document.getElementById(
                        "updatedAt-dropdown",
                      ) as HTMLElement;
                      if (updatedAtDropDownEl.style.opacity === "1") {
                        updatedAtDropDownEl.style.opacity = "0";
                      } else {
                        updatedAtDropDownEl.style.opacity = "1";
                      }
                    }}
                    className="w-[164px] flex justify-between p-2 rounded-full bg-orange-500 text-sm text-white font-sans font-[600] border-2 border-orange-700"
                  >
                    <p>UPDATED ON</p>
                    <div className="h-[20px] w-[20px] rounded-full bg-orange-50 text-orange-500">
                      {datesFilter.updated.length}
                    </div>
                    <div className="h-[20px] w-[20px] rounded-full bg-orange-50 text-orange-500">
                      ⯆
                    </div>
                  </button>
                  <div
                    id="updatedAt-dropdown"
                    className="absolute z-100 rounded-sm opacity-0 bg-orange-100 border-x-2 border-orange-700"
                  >
                    {datesFilter.updated.map((d) => (
                      <div
                        key={`updated-${d}`}
                        className="p-2 last:rounded-b-sm border-b-2 border-orange-700 font-mono font-semibold text-md text-orange-900"
                      >
                        {new Date(d).toDateString()}
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
        <div className="relative pt-[65px] w-full h-[718px] overflow-y-auto">
          {isLoadingEvidences ? (
            <p className="p-4 animate-pulse text-center text-sm text-gray-500">
              Loading evidences...
            </p>
          ) : filteredEvidences.length === 0 ? (
            <div className="absolute flex items-center justify-center gap-4 p-4">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                height="48px"
                viewBox="0 -960 960 960"
                width="48px"
                fill="#ca3500"
                className="inline-block"
              >
                <path d="M324-111.5Q251-143 197-197t-85.5-127Q80-397 80-480t31.5-156Q143-709 197-763t127-85.5Q397-880 480-880t156 31.5Q709-817 763-763t85.5 127Q880-563 880-480t-31.5 156Q817-251 763-197t-127 85.5Q563-80 480-80t-156-31.5ZM677-227q16-12 30-26t26-30L283-733q-16 12-30 26t-26 30l450 450Z" />
              </svg>
              <div className="font-sans text-4xl text-orange-700">
                No evidences found
              </div>
            </div>
          ) : (
            filteredEvidences.map((e: SocketEvidenceDetails) => {
              const key = `${e.id}`;
              return (
                <div
                  key={key}
                  className={`mx-2 my-2 p-4 rounded-sm font-mono font-semibold text-lg border-2 ${e.status === "active" ? "text-green-800 bg-green-50 border-green-700" : "text-gray-600 bg-gray-50 border-gray-500"}`}
                >
                  <Link href={`/evidence/${e.id}`} className="block font-mono">
                    ID:{" "}
                    <span className="hover:underline text-orange-700">
                      {e.id}
                    </span>
                  </Link>
                  <p>
                    Description:{" "}
                    <span className="text-orange-700">{e.description}</span>
                  </p>
                  <p>
                    Creator:{" "}
                    <span className="text-orange-700">{e.creator}</span> @{" "}
                    {bigintToDateWithTimeStamp(
                      BigInt(e.createdAt),
                    ).toLocaleString()}
                    {e.status !== "active" &&
                      " to " +
                        bigintToDateWithTimeStamp(
                          BigInt(e.updatedAt),
                        ).toLocaleString()}
                  </p>
                  <p>
                    {e.status === "active" ? "Current Owner: " : "Last Owner: "}
                    <span className="text-orange-700">
                      {e.currentOwner}
                    </span> @{" "}
                    {bigintToDateWithTimeStamp(
                      BigInt(e.updatedAt),
                    ).toLocaleString()}
                  </p>
                </div>
              );
            })
          )}
        </div>
      </div>
    </div>
  );
}
